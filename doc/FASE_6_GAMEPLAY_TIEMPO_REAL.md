# üéÆ FASE 6: Sistema de Juego en Tiempo Real - Plan Detallado
## üìä PROGRESO: 2/6 PASOS COMPLETADOS (33% ‚Üí Sistema Base Listo)

## üéØ Objetivo de Esta Fase
Implementar el sistema de gameplay en tiempo real con WebSockets, incluyendo fases de juego (d√≠a/noche), votaciones, chat en vivo y acciones b√°sicas de roles.

## ‚è±Ô∏è Tiempo Estimado
**Duraci√≥n:** 4-5 d√≠as  
**Prioridad:** üî¥ CR√çTICA (Core gameplay)

## ‚úÖ PRERREQUISITOS COMPLETADOS
- ‚úÖ Fase 5: Gesti√≥n de juegos completada
- ‚úÖ Sistema de salas de espera funcional
- ‚úÖ Autenticaci√≥n y autorizaci√≥n implementada
- ‚úÖ Base de datos con modelos de juego y roles
- ‚úÖ Frontend responsive con PrimeVue
- ‚úÖ **Paso 1 - WebSocket Setup**: Comunicaci√≥n en tiempo real establecida
- ‚úÖ **Paso 2 - Sistema de Fases de Juego**: Controlador autom√°tico de fases implementado

---

## üìã TAREAS ESPEC√çFICAS DETALLADAS

### 1Ô∏è‚É£ SETUP DE WEBSOCKETS EN BACKEND ‚úÖ COMPLETADO
**Prioridad:** üî¥ CR√çTICA  
**Tiempo:** 1 d√≠a  

#### 1.1 Configuraci√≥n de WebSocket Server ‚úÖ
**Archivo:** `backend/app/websocket/`
- [x] Instalar dependencias: `websockets`, `python-socketio`
- [x] Configurar FastAPI WebSocket manager
- [x] Implementar conexi√≥n/desconexi√≥n de clientes
- [x] Sistema de rooms por juego (game_id)
- [x] Manejo de errores y reconexi√≥n

#### 1.2 Protocolo de Mensajes ‚úÖ
**Archivo:** `backend/app/websocket/messages.py`
- [x] Definir tipos de mensajes:
  ```python
  # Implementados
  - HEARTBEAT
  - SYSTEM_MESSAGE
  - CHAT_MESSAGE
  - PLAYER_CONNECTED/DISCONNECTED
  - GAME_STARTED
  - PHASE_CHANGED
  - ERROR/SUCCESS
  ```
- [x] Validaci√≥n de mensajes con Pydantic
- [x] Serializaci√≥n JSON optimizada

#### 1.3 Game State Manager ‚úÖ
**Archivo:** `backend/app/services/game_state_service.py`
- [x] Gestor de estados de juego en memoria
- [x] Sincronizaci√≥n con base de datos
- [x] Sistema de heartbeat/keepalive
- [x] Manejo de desconexiones abruptas

#### 1.4 Frontend WebSocket Client ‚úÖ
**Archivos:** `frontend/src/services/websocket.ts`, `frontend/src/stores/realtime-game.ts`
- [x] Cliente WebSocket con reconexi√≥n autom√°tica
- [x] Sistema de eventos reactivos
- [x] Queue de mensajes offline
- [x] Heartbeat/ping-pong
- [x] Manejo de errores de conexi√≥n
- [x] Store Pinia para estado de juego en tiempo real
- [x] Composables para WebSocket
- [x] Componente de test WebSocket funcional

### 2Ô∏è‚É£ SISTEMA DE FASES DE JUEGO ‚úÖ COMPLETADO
**Prioridad:** üî¥ CR√çTICA  
**Tiempo:** 1.5 d√≠as

#### 2.1 Game Phase Controller ‚úÖ
**Archivo:** `backend/app/services/game_phases_service.py`
- [x] Estados de juego:
  ```python
  class GamePhase(Enum):
      WAITING = "waiting"      # Sala de espera
      STARTING = "starting"    # Iniciando juego
      NIGHT = "night"         # Fase nocturna
      DAY = "day"             # Fase diurna  
      VOTING = "voting"       # Votaciones
      TRIAL = "trial"         # Juicio/defensa
      EXECUTION = "execution" # Ejecuci√≥n
      FINISHED = "finished"   # Juego terminado
  ```
- [x] Transiciones autom√°ticas entre fases
- [x] Timers configurables por fase (PhaseConfig con duraciones personalizables)
- [x] Validaciones de estado
- [x] **Implementado**: GamePhaseController con ciclo autom√°tico d√≠a/noche
- [x] **Implementado**: Sistema de callbacks para eventos de cambio de fase
- [x] **Implementado**: Integraci√≥n completa con WebSocket para broadcasting en tiempo real
- [x] **Implementado**: GamePhaseManager para gesti√≥n global de m√∫ltiples juegos
- [x] **Implementado**: Timers as√≠ncronos con notificaciones de progreso

#### 2.2 Sistema de Turnos ‚úÖ
**Archivo:** `backend/app/services/game_phases_service.py` (integrado)
- [x] Cola de turnos por rol (integrado en GamePhaseController)
- [x] Manejo de acciones nocturnas (callbacks por fase)
- [x] Sistema de prioridades de roles (orden de fases)
- [x] Timeout de acciones (timers autom√°ticos)

#### 2.3 Condiciones de Victoria
**Archivo:** `backend/app/services/victory_service.py`
- [ ] Verificar condiciones despu√©s de cada fase
- [ ] Victoria de Hombres Lobo vs Aldeanos
- [ ] Condiciones especiales (amantes, ni√±o salvaje)
- [ ] Calcular estad√≠sticas finales

---

## üéØ PROGRESO ACTUAL - PASOS COMPLETADOS

### ‚úÖ PASO 1 COMPLETADO: WebSocket Setup
- **Estado**: 100% implementado y funcional
- **Archivos creados/modificados**: 
  - `backend/app/websocket/connection_manager.py` - Gestor de conexiones WebSocket
  - `backend/app/websocket/messages.py` - Modelos de mensajes con serializaci√≥n JSON
  - `backend/app/websocket/message_handlers.py` - Handlers principales
  - `backend/app/websocket/game_handlers.py` - Handlers espec√≠ficos de juego
- **Funcionalidades**: 
  - ‚úÖ Conexi√≥n WebSocket estable con autenticaci√≥n JWT
  - ‚úÖ Sistema de rooms por juego
  - ‚úÖ Heartbeat autom√°tico
  - ‚úÖ Manejo de desconexiones
  - ‚úÖ Serializaci√≥n JSON correcta con datetime

### ‚úÖ PASO 2 COMPLETADO: Sistema de Fases de Juego
- **Estado**: 100% implementado con funcionalidad completa
- **Archivo principal**: `backend/app/services/game_phases_service.py` (400+ l√≠neas)
- **Caracter√≠sticas implementadas**:
  - ‚úÖ **GamePhaseController**: Controlador principal con 8 fases (WAITING‚ÜíSTARTING‚ÜíNIGHT‚ÜíDAY‚ÜíVOTING‚ÜíTRIAL‚ÜíEXECUTION‚ÜíFINISHED)
  - ‚úÖ **PhaseConfig**: Sistema configurable de duraciones por fase (defaults: 1min starting, 3min night, 5min day, 2min voting/trial, 1min execution)
  - ‚úÖ **Transiciones autom√°ticas**: Ciclo autom√°tico d√≠a/noche con timers
  - ‚úÖ **Sistema de callbacks**: Notificaci√≥n de cambios de fase y actualizaciones de timer
  - ‚úÖ **Integraci√≥n WebSocket**: Broadcasting en tiempo real de cambios de fase
  - ‚úÖ **GamePhaseManager**: Gesti√≥n global de m√∫ltiples juegos simult√°neos
  - ‚úÖ **Compatibilidad**: Capa de compatibilidad con GameStatus existente
- **Testing**: Script de prueba funcional (`test_game_phases.py`) - conexi√≥n WebSocket verificada

### üéØ SIGUIENTE PASO: Sistema de Votaciones
- **Archivo objetivo**: `backend/app/services/voting_service.py`
- **Dependencias**: Construir sobre el sistema de fases implementado
- **Integraci√≥n**: Usar callbacks de fase VOTING para activar sistema de votaci√≥n

---

### 3Ô∏è‚É£ SISTEMA DE VOTACIONES
**Prioridad:** üî¥ CR√çTICA  
**Tiempo:** 1 d√≠a

#### 3.1 Voting Service
**Archivo:** `backend/app/services/voting_service.py`
- [ ] Crear votaci√≥n (d√≠a/sheriff/other)
- [ ] Registrar votos de jugadores
- [ ] Conteo autom√°tico de votos
- [ ] Manejo de empates
- [ ] Voto doble del sheriff
- [ ] Eliminaci√≥n por mayor√≠a

#### 3.2 Voting WebSocket Handlers
**Archivo:** `backend/app/websocket/voting_handlers.py`
- [ ] `cast_vote` - Emitir voto
- [ ] `get_voting_status` - Estado actual
- [ ] Broadcast de cambios en tiempo real
- [ ] Validar derecho a voto (vivo/muerto)

### 4Ô∏è‚É£ FRONTEND WEBSOCKET CLIENT
**Prioridad:** üî¥ CR√çTICA  
**Tiempo:** 1 d√≠a

#### 4.1 WebSocket Service
**Archivo:** `frontend/src/services/websocket.ts`
- [ ] Cliente WebSocket con reconexi√≥n autom√°tica
- [ ] Sistema de eventos reactivos
- [ ] Queue de mensajes offline
- [ ] Heartbeat/ping-pong
- [ ] Manejo de errores de conexi√≥n

#### 4.2 Game Store con WebSocket
**Archivo:** `frontend/src/stores/realtime-game.ts`
- [ ] Store Pinia para estado de juego en tiempo real
- [ ] Sincronizaci√≥n bidireccional con backend
- [ ] Estado de conexi√≥n WebSocket
- [ ] Cache local para offline mode

#### 4.3 Composables para WebSocket
**Archivo:** `frontend/src/composables/useWebSocket.ts`
- [ ] `useGameSocket()` - Conexi√≥n por juego
- [ ] `useVoting()` - Sistema de votaci√≥n
- [ ] `useChat()` - Chat en tiempo real
- [ ] `useGamePhase()` - Estados de juego

### 5Ô∏è‚É£ INTERFAZ DE GAMEPLAY
**Prioridad:** üî¥ CR√çTICA  
**Tiempo:** 1.5 d√≠as

#### 5.1 GamePlayView
**Archivo:** `frontend/src/views/GamePlayView.vue`
- [ ] Layout principal del juego activo
- [ ] Panel de informaci√≥n del juego
- [ ] Lista de jugadores vivos/muertos
- [ ] Indicador de fase actual
- [ ] Timer de fase
- [ ] Panel de acciones seg√∫n rol

#### 5.2 VotingPanel Component
**Archivo:** `frontend/src/components/game/VotingPanel.vue`
- [ ] Lista de jugadores para votar
- [ ] Botones de votaci√≥n
- [ ] Contador de votos en tiempo real
- [ ] Resultados de votaci√≥n
- [ ] Estados: abierta/cerrada/completada

#### 5.3 GamePhaseIndicator
**Archivo:** `frontend/src/components/game/GamePhaseIndicator.vue`
- [ ] Indicador visual de fase actual
- [ ] Countdown timer animado
- [ ] Transiciones entre fases
- [ ] Instrucciones contextuales

#### 5.4 PlayersGrid
**Archivo:** `frontend/src/components/game/PlayersGrid.vue`
- [ ] Grid de jugadores en el juego
- [ ] Estados: vivo/muerto/sospechoso
- [ ] Avatares con indicadores de rol (si revelado)
- [ ] Acciones disponibles (votar, usar habilidad)
- [ ] Animaciones de eliminaci√≥n

### 6Ô∏è‚É£ SISTEMA DE CHAT EN TIEMPO REAL
**Prioridad:** üü° ALTA  
**Tiempo:** 0.5 d√≠as

#### 6.1 Chat Backend
**Archivo:** `backend/app/websocket/chat_handlers.py`
- [ ] Mensajes de chat por canal
- [ ] Filtros por estado (vivos/muertos)
- [ ] Sistema de moderaci√≥n b√°sico
- [ ] Historial de mensajes

#### 6.2 Chat Component
**Archivo:** `frontend/src/components/game/ChatComponent.vue`
- [ ] Input de mensaje con validaci√≥n
- [ ] Lista de mensajes en tiempo real
- [ ] Diferentes canales seg√∫n estado
- [ ] Indicadores de escritura
- [ ] Scroll autom√°tico

---

## üéØ ARQUITECTURA T√âCNICA DETALLADA

### Backend WebSocket Architecture
```
backend/app/
‚îú‚îÄ‚îÄ websocket/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ connection_manager.py    # Gestor de conexiones WS
‚îÇ   ‚îú‚îÄ‚îÄ message_handlers.py      # Handlers por tipo mensaje
‚îÇ   ‚îú‚îÄ‚îÄ game_handlers.py         # Handlers espec√≠ficos de juego
‚îÇ   ‚îú‚îÄ‚îÄ voting_handlers.py       # Handlers de votaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ chat_handlers.py         # Handlers de chat
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ game_state_service.py    # Estado de juego en memoria
‚îÇ   ‚îú‚îÄ‚îÄ game_phases_service.py   # L√≥gica de fases
‚îÇ   ‚îú‚îÄ‚îÄ voting_service.py        # Sistema de votaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ turn_service.py          # Manejo de turnos
‚îÇ   ‚îî‚îÄ‚îÄ victory_service.py       # Condiciones de victoria
‚îî‚îÄ‚îÄ models/
    ‚îú‚îÄ‚îÄ websocket_models.py      # Modelos para WebSocket
    ‚îî‚îÄ‚îÄ game_events.py           # Eventos de juego
```

### Frontend Real-time Architecture
```
frontend/src/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ websocket.ts             # Cliente WebSocket
‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îî‚îÄ‚îÄ realtime-game.ts         # Store para tiempo real
‚îú‚îÄ‚îÄ composables/
‚îÇ   ‚îú‚îÄ‚îÄ useWebSocket.ts          # WebSocket composable
‚îÇ   ‚îú‚îÄ‚îÄ useVoting.ts             # Votaci√≥n composable
‚îÇ   ‚îî‚îÄ‚îÄ useGamePhase.ts          # Fases composable
‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îî‚îÄ‚îÄ GamePlayView.vue         # Vista principal del juego
‚îî‚îÄ‚îÄ components/game/
    ‚îú‚îÄ‚îÄ VotingPanel.vue          # Panel de votaci√≥n
    ‚îú‚îÄ‚îÄ GamePhaseIndicator.vue   # Indicador de fase
    ‚îú‚îÄ‚îÄ PlayersGrid.vue          # Grid de jugadores
    ‚îú‚îÄ‚îÄ ChatComponent.vue        # Chat en tiempo real
    ‚îî‚îÄ‚îÄ RoleActions.vue          # Acciones por rol
```

### Protocolo de Mensajes WebSocket
```typescript
interface WebSocketMessage {
  type: MessageType
  game_id: string
  player_id: string
  timestamp: string
  data: any
}

enum MessageType {
  // Connection
  PLAYER_CONNECTED = "player_connected"
  PLAYER_DISCONNECTED = "player_disconnected"
  
  // Game phases
  PHASE_CHANGED = "phase_changed"
  PHASE_TIMER = "phase_timer"
  
  // Voting
  VOTE_CAST = "vote_cast"
  VOTING_RESULTS = "voting_results"
  
  // Chat
  CHAT_MESSAGE = "chat_message"
  
  // Role actions
  ROLE_ACTION = "role_action"
  
  // Game events
  PLAYER_ELIMINATED = "player_eliminated"
  GAME_ENDED = "game_ended"
}
```

---

## üéØ CRITERIOS DE √âXITO

### ‚úÖ Comunicaci√≥n en Tiempo Real
- [ ] Conexi√≥n WebSocket estable con reconexi√≥n autom√°tica
- [ ] Latencia < 100ms para mensajes cr√≠ticos
- [ ] Manejo robusto de desconexiones
- [ ] Sincronizaci√≥n perfecta entre clientes

### ‚úÖ Sistema de Fases
- [ ] Transiciones autom√°ticas entre d√≠a/noche
- [ ] Timers configurables y sincronizados
- [ ] Estados consistentes entre todos los clientes
- [ ] Manejo de edge cases (desconexiones durante transici√≥n)

### ‚úÖ Votaciones Funcionales
- [ ] Registro de votos en tiempo real
- [ ] Conteo autom√°tico y preciso
- [ ] Manejo correcto de empates
- [ ] Feedback visual inmediato

### ‚úÖ Interfaz de Usuario
- [ ] UI responsive durante el gameplay
- [ ] Indicadores claros de fase y tiempo
- [ ] Interacciones fluidas e intuitivas
- [ ] Feedback visual para todas las acciones

---

## üöÄ PREPARACI√ìN PARA FASE 7

Esta fase establece la base para:
- Implementaci√≥n de roles especiales complejos
- Acciones nocturnas espec√≠ficas por rol
- Mec√°nicas avanzadas (amantes, transformaciones)
- Sistema de habilidades especiales

---

## üìä IMPACTO EN EL PROYECTO

**Al completar los pasos 1-2 tenemos:**
- üéÆ **Sistema de comunicaci√≥n en tiempo real establecido** ‚úÖ - WebSocket funcionando con autenticaci√≥n JWT
- ‚ö° **Sistema autom√°tico de fases d√≠a/noche** ‚úÖ - Ciclo completo con timers configurables
- üîÑ **Base s√≥lida para votaciones y roles** ‚úÖ - Callbacks y broadcasting implementados
- üåê **Infraestructura WebSocket robusta** ‚úÖ - Manejo de conexiones, heartbeat y recuperaci√≥n

**Al completar la fase completa tendremos:**
- üéÆ Gameplay b√°sico completamente funcional
- ‚ö° Comunicaci√≥n en tiempo real establecida ‚úÖ
- üó≥Ô∏è Sistema de votaciones operativo
- üí¨ Chat en vivo durante partidas
- üîÑ Base s√≥lida para roles especiales complejos ‚úÖ

**Progreso del proyecto:** 62.5% ‚Üí 75% (completando pasos 1-2 de Fase 6)

---

## üîß DEPENDENCIAS T√âCNICAS

### Backend Dependencies
```bash
# Nuevas dependencias para WebSocket
pip install websockets
pip install python-socketio
pip install python-socketio[asyncio_client]
```

### Frontend Dependencies
```bash
# Cliente WebSocket para Vue.js
npm install socket.io-client
npm install @types/socket.io-client
```

---

## ‚ö†Ô∏è RIESGOS Y CONSIDERACIONES

### Riesgos T√©cnicos:
- **Complejidad de sincronizaci√≥n** - Estados distribuidos pueden desincronizarse
- **Manejo de desconexiones** - Usuarios perdiendo conexi√≥n durante el juego
- **Escalabilidad WebSocket** - Performance con m√∫ltiples juegos simult√°neos
- **Estado inconsistente** - Race conditions en votaciones

### Mitigaciones:
- Implementar sistema robusto de reconexi√≥n
- Cache de estado local para recuperaci√≥n
- Validaci√≥n de estado en backend
- Sistema de locks para operaciones cr√≠ticas

---

## üìù NOTAS DE IMPLEMENTACI√ìN

### Orden de Desarrollo Recomendado:
1. **Backend WebSocket b√°sico** - Conexi√≥n y mensajes simples
2. **Frontend WebSocket client** - Integraci√≥n con Vue.js
3. **Sistema de fases b√°sico** - D√≠a/noche autom√°tico
4. **Votaciones simples** - Eliminaci√≥n por mayor√≠a
5. **Interfaz de gameplay** - UI completa
6. **Chat en tiempo real** - Comunicaci√≥n entre jugadores
7. **Pulido y testing** - Casos edge y optimizaci√≥n

### Testing Strategy:
- Unit tests para l√≥gica de votaci√≥n
- Integration tests para WebSocket
- E2E tests para flujo completo de juego
- Load testing para m√∫ltiples usuarios

---

> **üéØ OBJETIVO:** Sistema de juego en tiempo real completamente funcional
> 
> **üèÅ RESULTADO ESPERADO:** Jugadores pueden jugar partidas completas con votaciones, chat y fases autom√°ticas
